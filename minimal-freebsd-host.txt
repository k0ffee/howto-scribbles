:
: Minimal FreeBSD host setup:
:

cat > /etc/resolv.conf <<'EOF'
#
# Temporary setup before unbound is up:
#
nameserver 194.29.226.55
nameserver 194.29.230.55
nameserver 94.198.61.84
options edns0
EOF

ASSUME_ALWAYS_YES=yes \
    pkg install zsh bash sudo screen shmux tmux ssmtp ca_root_nss
cp /usr/share/zoneinfo/Europe/Berlin /etc/localtime

cat > /etc/rc.conf <<'EOF'
unbound_enable="YES"
sshd_enable="YES"
sendmail_enable="NO"
sendmail_submit_enable="NO"
sendmail_outbound_enable="NO"
sendmail_msp_queue_enable="NO"
syslogd_flags="-ss"
EOF

service sshd start

cat <<'EOF'
# /etc/ssh/sshd_config:
# PermitRootLogin without-password
# UseDNS no
# UsePAM no
EOF
if cd /etc/ssh; then
    sed 's/^[[:space:]#]*\(PermitRootLogin\).*/\1 without-password/' \
        < sshd_config > sshd_config~ && sshd -tf sshd_config~ && \
            mv sshd_config~ sshd_config
    sed 's/^[[:space:]#]*\(UsePAM\).*/\1 no/' \
        < sshd_config > sshd_config~ && sshd -tf sshd_config~ && \
            mv sshd_config~ sshd_config
    sed 's/^[[:space:]#]*\(UseDNS\).*/\1 no/' \
        < sshd_config > sshd_config~ && sshd -tf sshd_config~ && \
            mv sshd_config~ sshd_config
    grep -E '^[[:space:]#]*(PermitRootLogin|Use(DNS|PAM))[[:space:]]' \
        sshd_config
fi
service sshd restart

cat > /etc/periodic.conf <<'EOF'
#
# /etc/periodic.conf overrides the defaults in /etc/defaults/periodic.conf
#
daily_output="/var/log/daily.log"
weekly_output="/var/log/weekly.log"
monthly_output="/var/log/monthly.log"
daily_status_security_output="/var/log/daily.log"
weekly_status_security_output="/var/log/weekly.log"
monthly_status_security_output="/var/log/monthly.log"
#
# Locate on large storage just eats too much data,
# also it violates privacy of home-directories.
#
weekly_locate_enable="NO"
EOF

ASSUME_ALWAYS_YES=yes pkg install unbound

myaddress=`ifconfig lagg0 | awk '/inet6 /{print$2}' | head -1`
if [ -n "$myaddress" ]; then
    cat > /usr/local/etc/unbound/unbound.conf <<EOF
server:
    interface: $myaddress
    access-control: $myaddress/128 allow 
    verbosity: 0
EOF
else
    cat > /usr/local/etc/unbound/unbound.conf <<'EOF'
server:
    interface: 0.0.0.0
    access-control: 10.0.0.0/8 allow 
    verbosity: 0
EOF
fi

if [ -n "$myaddress" ]; then
    echo nameserver $myaddress > /etc/resolv.conf
    echo options edns0 >> /etc/resolv.conf
else
    cat > /etc/resolv.conf <<'EOF'
nameserver 194.29.226.55
nameserver 194.29.230.55
nameserver 94.198.61.84
options edns0
EOF
fi

cat > /etc/unbound/forward.conf <<'EOF'
# This file was generated by local-unbound-setup.
# Modifications will be overwritten.
EOF
service unbound start

cat >> /usr/local/etc/sudoers.d/admin-sudoers <<'EOF'
%admins ALL=(ALL) NOPASSWD: ALL
EOF
chmod 640 /usr/local/etc/sudoers.d/admin-sudoers

name=`hostname`
cat > /usr/local/etc/ssmtp/ssmtp.conf <<EOF
root=root@example.com
mailhub=mail-b
rewriteDomain=example.com
hostname=$name
EOF

cat > /etc/mail/mailer.conf <<'EOF'
sendmail        /usr/local/sbin/ssmtp
send-mail       /usr/local/sbin/ssmtp
mailq           /usr/local/sbin/ssmtp
newaliases      /usr/local/sbin/ssmtp
hoststat        /usr/bin/true
purgestat       /usr/bin/true
EOF

pw groupadd admins -g 5001
pw useradd tino.reinhardt -u 5014 -g admins -s /usr/local/bin/zsh -m -M 700
mkdir -p /root/.ssh
mkdir -p /home/tino.reinhardt/.ssh

cat > /root/.ssh/authorized_keys <<'EOF'
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDeMtnF0ztTfqCTm7LDP0fa7MLZFTm+4aSVA3GhyZB95O230u1nMQ1uYSkorAArYaWmoz+SZw5KR9l5Nc+38S8+q8gkdxDDfiPS+ArFQsT5Ba/K70t2AU45oigbXbg9Q1sEc8u5LNOBRLTGuDBpmW0/vclFZmzj7SIpU4GRgTqDBXKTXeVVXU5TzKzbL7u0ASulQ1x67aaZOWUwEu49fwohFrPreDiU9HfZQHaf7EYwScvKyVMLSbRUaVZIUMMJym4TN5dbVdUpUZAEZsMu/D8bU4mJblFlyf9zDdDRrdU2mvU9tnnPKWAVDM82I0W5oa80OkeXGLrFQs7p/GlPO3JRE5aHRE71JYM/XuY+UGr2j4oG8y6t5jw3OCgowWImCs4+JL6Uf/ZB2mHN2lLofzomFY3Jy/2rgRdR9x8h2OdDRy9rARcKc8QEu7s8xsy77ojjpmFqsm9h04fsP3jB9xhI/VyacVQXzur9MeF58n99eded+pFCFAQtn/Q6W5wZ8/ALSsvnEO5i9MkdxoknF6I6ROhRU1mlQiPq2UUjVIWdFPsn3kUkvbxwZrnYUOmEr4+kmOfD9rkeBvsgE7bqTcVPZGY362bAKy8TOgmOxK396E0TNwLrO3pNcVmbBc+HLefpWLADXbhOrm5Ud0pXvkJHr0X8WEOcfMGE6fN3+AwceQ== tino@
EOF
chmod 644 /root/.ssh/authorized_keys

cat > /home/tino.reinhardt/.ssh/authorized_keys <<'EOF'
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDeMtnF0ztTfqCTm7LDP0fa7MLZFTm+4aSVA3GhyZB95O230u1nMQ1uYSkorAArYaWmoz+SZw5KR9l5Nc+38S8+q8gkdxDDfiPS+ArFQsT5Ba/K70t2AU45oigbXbg9Q1sEc8u5LNOBRLTGuDBpmW0/vclFZmzj7SIpU4GRgTqDBXKTXeVVXU5TzKzbL7u0ASulQ1x67aaZOWUwEu49fwohFrPreDiU9HfZQHaf7EYwScvKyVMLSbRUaVZIUMMJym4TN5dbVdUpUZAEZsMu/D8bU4mJblFlyf9zDdDRrdU2mvU9tnnPKWAVDM82I0W5oa80OkeXGLrFQs7p/GlPO3JRE5aHRE71JYM/XuY+UGr2j4oG8y6t5jw3OCgowWImCs4+JL6Uf/ZB2mHN2lLofzomFY3Jy/2rgRdR9x8h2OdDRy9rARcKc8QEu7s8xsy77ojjpmFqsm9h04fsP3jB9xhI/VyacVQXzur9MeF58n99eded+pFCFAQtn/Q6W5wZ8/ALSsvnEO5i9MkdxoknF6I6ROhRU1mlQiPq2UUjVIWdFPsn3kUkvbxwZrnYUOmEr4+kmOfD9rkeBvsgE7bqTcVPZGY362bAKy8TOgmOxK396E0TNwLrO3pNcVmbBc+HLefpWLADXbhOrm5Ud0pXvkJHr0X8WEOcfMGE6fN3+AwceQ== tino@
EOF
chmod 644 /home/tino.reinhardt/.ssh/authorized_keys
chown -R  tino.reinhardt:admins /home/tino.reinhardt
